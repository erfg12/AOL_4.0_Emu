image: Visual Studio 2022
skip_tags: true
platform: Any CPU
configuration: Release

branches:
  only:
    - master

skip_commits:
  message: /\[skip ci\]|\[ci skip\]/

install:
  # Download and install the Installer Projects extension
  - ps: |
      Write-Host "Downloading Visual Studio Installer Projects extension..."
      $vsixUrl = "https://marketplace.visualstudio.com/_apis/public/gallery/publishers/VisualStudioClient/vsextensions/MicrosoftVisualStudio2022InstallerProjects/2.0.1/vspackage"
      $vsixPath = "$env:TEMP\InstallerProjects.vsix"
      $progressPreference = 'silentlyContinue'
      Invoke-WebRequest -Uri $vsixUrl -OutFile $vsixPath
      Write-Host "Installing extension..."
      
      # Try Community first, then BuildTools
      $vsixInstallers = @(
        "C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\IDE\VSIXInstaller.exe",
        "C:\Program Files (x86)\Microsoft Visual Studio\2022\Community\Common7\IDE\VSIXInstaller.exe",
        "C:\Program Files\Microsoft Visual Studio\2022\BuildTools\Common7\IDE\VSIXInstaller.exe"
      )
      
      $installed = $false
      foreach ($installer in $vsixInstallers) {
        if (Test-Path $installer) {
          Write-Host "Using installer: $installer"
          & $installer /quiet $vsixPath
          Write-Host "Exit code: $LASTEXITCODE"
          if ($LASTEXITCODE -eq 0 -or $LASTEXITCODE -eq 1001) {
            $installed = $true
            Write-Host "Extension installed successfully"
            break
          }
        }
      }
      
      if (-not $installed) {
        Write-Warning "Could not install extension, attempting to build anyway..."
      }

before_build:
  - nuget restore

build_script:
  # Build main project
  - dotnet build aol_4/aol_4.csproj -c Release

  # Build MSI installer
  - msbuild Installer/Installer.vdproj /p:Configuration=Release /v:detailed

artifacts:
  - path: aol_4/bin/Release/
    name: Latest
  - path: Installer/Release/*.msi
    name: Installer

deploy:
  - provider: GitHub
    tag: $(APPVEYOR_BUILD_ID)
    release: Build $(APPVEYOR_REPO_COMMIT_TIMESTAMP)
    description: |
      Latest Compile Date %APPVEYOR_REPO_COMMIT_TIMESTAMP%
      %APPVEYOR_REPO_COMMIT_MESSAGE%
    auth_token:
      secure: fGvksY5wIwuWGimQncSWs2w1d7KrrErQ05CCNYnd/Q5i8zxiczeIwvhA8gDjWGy+
    artifact: Latest, Installer